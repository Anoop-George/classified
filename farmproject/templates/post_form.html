{% extends "base.html" %}
{% load static %}
{% load widget_tweaks %}

{% block content %}
<div class="container mt-4 mb-5">
  <div class="row justify-content-center">
    <div class="col-md-8">

      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h4 class="mb-0">Create New Post</h4>
        </div>

        <div class="card-body">
          <form method="POST" enctype="multipart/form-data">
            {% if form.errors %}
            <div class="alert alert-danger">
              <pre>{{ form.errors }}</pre>
            </div>
            {% endif %}
            {% csrf_token %}

            {{ form.non_field_errors }}

            <div class="form-group">
              <label for="id_title">Title</label>
              {{ form.title|add_class:"form-control" }}
              {{ form.title.errors }}
            </div>

            <div class="form-group">
              <label>Description</label>
              {{ form.contents|add_class:"form-control" }}
              {{ form.contents.errors }}
            </div>

            <div class="form-group">
              <label>Category</label>
              {{ form.category|add_class:"form-control" }}
              {{ form.category.errors }}
            </div>

            <div class="form-group">
              <label>Contact Phone</label>
              {{ form.phone_number|add_class:"form-control" }}
              {{ form.phone_number.errors }}
            </div>

            <div class="form-group">
              <label>Postcode</label>
              {{ form.postcode|add_class:"form-control" }}
              {{ form.postcode.errors }}
            </div>

            <div class="form-group">
              <label>District</label>
              {{ form.district|add_class:"form-control" }}
              {{ form.district.errors }}
            </div>

            <!-- FIXED IMAGE INPUT -->
            <div class="form-group">
              <label>Upload Images (max 6)</label>
              {{ form.images }}
              {{ form.images.errors }}

              <div id="preview" class="mt-3 d-flex flex-wrap"></div>
            </div>

            <div class="text-right mt-4">
              <button type="submit" class="btn btn-success btn-lg">Submit Post</button>
            </div>
            <div id="preview" style="display:flex; flex-wrap:wrap"></div>

          </form>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const fileInput = document.getElementById("id_images");
    const preview = document.getElementById("preview");

    if (!fileInput) return;

    fileInput.addEventListener("change", function () {
      preview.innerHTML = "";

      [...this.files].forEach(file => {
        if (!file.type.startsWith("image/")) return;

        const reader = new FileReader();
        reader.onload = function (e) {
          const div = document.createElement("div");
          div.style.width = "100px";
          div.style.height = "100px";
          div.style.margin = "5px";
          div.style.border = "1px solid #ccc";

          const img = document.createElement("img");
          img.src = e.target.result;
          img.style.width = "100%";
          img.style.height = "100%";
          img.style.objectFit = "cover";

          div.appendChild(img);
          preview.appendChild(div);
        };
        reader.readAsDataURL(file);
      });
    });
  });
</script>

<script>
  const fileInput = document.getElementById("id_images");
  const previewContainer = document.getElementById("preview");

  const MAX_WIDTH = 1280;                 // Max resolution after compress
  const SIZE_LIMIT = 15 * 1024 * 1024;    // Compress only if > 15 MB

  fileInput.addEventListener("change", async function (event) {
    const files = Array.from(event.target.files);
    previewContainer.innerHTML = ""; // Reset preview

    const finalFiles = [];

    for (const file of files) {
      // Immediate thumbnail preview
      const preview = document.createElement("img");
      preview.src = URL.createObjectURL(file);
      preview.style.maxWidth = "100px";
      preview.style.margin = "5px";
      previewContainer.appendChild(preview);

      // If file is small â†’ do not compress
      if (file.size <= SIZE_LIMIT) {
        finalFiles.push(file);
        continue;
      }

      // Compress only large files (> 15MB)
      const compressed = await compressImage(file);
      finalFiles.push(compressed);
    }

    // Replace real file input with compressed ones
    const dataTransfer = new DataTransfer();
    finalFiles.forEach(f => dataTransfer.items.add(f));
    fileInput.files = dataTransfer.files;
  });

  async function compressImage(file) {
    return new Promise(resolve => {
      const reader = new FileReader();
      reader.readAsDataURL(file);

      reader.onload = event => {
        const img = new Image();
        img.src = event.target.result;

        img.onload = () => {
          const canvas = document.createElement("canvas");
          let width = img.width;
          let height = img.height;

          // Scale down large images
          if (width > MAX_WIDTH) {
            height = Math.round(height * (MAX_WIDTH / width));
            width = MAX_WIDTH;
          }

          canvas.width = width;
          canvas.height = height;

          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0, width, height);

          // Export as compressed JPEG
          canvas.toBlob(
            blob => {
              const newFile = new File(
                [blob],
                file.name.replace(/\..+$/, ".jpg"),
                {
                  type: "image/jpeg",
                  lastModified: Date.now()
                }
              );
              resolve(newFile);
            },
            "image/jpeg",
            0.7 // compression quality
          );
        };
      };
    });
  }
</script>


{% endblock %}