{% extends "base.html" %}

{% block content %}

<div class="container mt-4">

  {% if not post.admin_verified %}
  <div class="alert alert-warning">
    <strong>Admin Preview:</strong>
    This post is not yet verified. Only admin/staff can see it.
  </div>
  {% endif %}

  <h2>{{ post.title }}</h2>

  <p class="text-muted mb-1">
    Category: <strong>{{ post.get_category_display }}</strong> â€¢
    District: <strong>{{ post.district }}</strong> â€¢
    Postcode: <strong>{{ post.postcode }}</strong>
  </p>

  {% if post.admin_verified %}
  <p class="text-muted">Views: {{ post.view_count }}</p>
  {% endif %}

  <!-- ================= IMAGE CAROUSEL ================= -->
  {% if post.images.count %}
  <div id="postCarousel" class="carousel slide mb-4" data-ride="carousel">
    <div class="carousel-inner">

      {% for img in post.images.all %}
      <div class="carousel-item {% if forloop.first %}active{% endif %}">
        <picture>
          {% if img.webp_image %}
          <source srcset="{{ img.webp_image.url }}" type="image/webp">
          {% endif %}
          <img src="{{ img.image.url }}" class="d-block w-100" style="max-height:400px; object-fit:cover;">
        </picture>
      </div>
      {% endfor %}

    </div>

    {% if post.images.count > 1 %}
    <a class="carousel-control-prev" href="#postCarousel" role="button" data-slide="prev">
      <span class="carousel-control-prev-icon"></span>
    </a>
    <a class="carousel-control-next" href="#postCarousel" role="button" data-slide="next">
      <span class="carousel-control-next-icon"></span>
    </a>
    {% endif %}
  </div>
  {% endif %}

  <!-- ================= CONTENT ================= -->
  <div class="card mb-4">
    <div class="card-body">

      <p style="white-space: pre-line;">{{ post.contents }}</p>

      <h5 class="mt-3">Contact</h5>
      <!-- ========================= -->
      <!-- CALL SELLER (CALL-FIRST UX) -->
      <!-- ========================= -->

      <div class="card mt-4">
        <div class="card-body text-center">

          <h5 class="mb-3">Contact Seller</h5>

          <!-- Hidden phone -->
          <div id="phone-box" class="d-none">
            <a id="call-link" class="btn btn-success btn-lg btn-block" href="#">
              ðŸ“ž Call {{ post.phone_number|slice:":2" }}******{{ post.phone_number|slice:"-2:" }}
            </a>
          </div>

          <!-- Show button -->
          <button id="show-phone-btn" class="btn btn-primary btn-lg btn-block" onclick="revealPhone()">
            ðŸ“ž Call Seller
          </button>

          <small class="text-muted d-block mt-2">
            Click to reveal phone number
          </small>

        </div>
      </div>

      <p>
        Phone: <strong>{{ post.phone_number }}</strong><br>
        Posted by:
        <strong>
          {{ post.created_by.phone_number|default:"Anonymous" }}
        </strong>
      </p>


      <div class="mb-3">
        <h4 class="text-success">


          â‚¹ {{ post.price|floatformat:0 }}


        </h4>
      </div>
      <!-- ================= SHARE BUTTONS ================= -->
      <div class="mt-3">
        <h5>Share this post:</h5>

        <a href="{{ share_facebook }}" target="_blank" class="btn btn-primary btn-sm mr-2">
          Facebook
        </a>

        <a href="https://wa.me/?text={{ whatsapp_text|urlencode }}" target="_blank"
          class="btn btn-success btn-lg btn-block mt-2">
          ðŸ“² Share on WhatsApp
        </a>

        <a href="{{ share_instagram }}" target="_blank" class="btn btn-danger btn-sm">
          Instagram
        </a>
      </div>
      {% if post.created_by.is_verified_seller %}
      <span class="badge badge-success mb-2">Verified Seller</span>
      {% endif %}
      <!-- ================= REPORT SPAM ================= -->
      {% if post.admin_verified %}
      <form method="post" class="mt-3">
        {% csrf_token %}
        <button name="report_spam" class="btn btn-sm btn-outline-danger">
          Report Spam / Fake
        </button>
      </form>
      {% endif %}

      <!-- IMPORTANT:
           âŒ NO spam status shown to public
           âŒ NO button disabling
           âœ” Always same UI
      -->

    </div>
  </div>


  <a href="{% url 'post_list' %}" class="btn btn-secondary">
    Back to Posts
  </a>

</div>

<script>
  function revealPhone() {
    setTimeout(() => {
      const phone = "{{ post.phone_number }}";
      const callLink = document.getElementById("call-link");

      callLink.href = "tel:" + phone;
      callLink.innerText = "ðŸ“ž Call " + phone;

      document.getElementById("phone-box").classList.remove("d-none");
      document.getElementById("show-phone-btn").classList.add("d-none");
    }, 1000);
  }

</script>


{% endblock %}